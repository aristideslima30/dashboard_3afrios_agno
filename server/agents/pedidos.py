from ..integrations.openai_client import generate_response
from .service import get_service_utils
from typing import List, Dict, Any, Tuple
import logging
import re
import unicodedata

# Roberto - Especialista em Pedidos
ROBERTO_PERSONALITY = {
    'nome': 'Roberto',
    'cargo': 'Especialista em pedidos da 3A Frios',
    'tom': 'eficiente, atencioso e organizador',
    'especialidades': ['gest√£o de pedidos', 'c√°lculos', 'log√≠stica', 'confirma√ß√µes']
}

# Informa√ß√µes do sistema de delivery
DELIVERY_INFO = {
    'formas_pagamento': [
        'Dinheiro na entrega',
        'Cart√£o de cr√©dito na entrega', 
        'PIX',
        'Transfer√™ncia banc√°ria'
    ],
    'taxa_entrega': {
        'ate_3km': 'Gr√°tis',
        '3_5km': 'R$ 3,00',
        'acima_5km': 'R$ 5,00'
    },
    'prazo_entrega': '24-48h na regi√£o',
    'horario_pedidos': 'Segunda a Sexta: 7h √†s 18h | S√°bado: 7h √†s 12h'
}

# Estados do processo de pedido
class EstadoPedido:
    INICIANDO = "iniciando"
    COLETANDO_ITENS = "coletando_itens"
    VALIDANDO_PRODUTOS = "validando_produtos"
    CALCULANDO_TOTAL = "calculando_total"
    COLETANDO_ENDERECO = "coletando_endereco"
    ESCOLHENDO_PAGAMENTO = "escolhendo_pagamento"
    CONFIRMANDO = "confirmando"
    FINALIZADO = "finalizado"

logger = logging.getLogger("3afrios.backend")

def _norm(s: str) -> str:
    """Normaliza string removendo acentos e convertendo para min√∫sculas"""
    s = (s or "").strip().lower()
    s = unicodedata.normalize('NFD', s)
    s = ''.join(ch for ch in s if unicodedata.category(ch) != 'Mn')
    return s

def _extract_items_from_message(message: str) -> List[Dict[str, Any]]:
    """Extrai itens e quantidades da mensagem do cliente"""
    text = _norm(message)
    items = []
    
    # Padr√µes para detectar quantidades + produtos
    patterns = [
        r'(\d+(?:[.,]\d+)?)\s*(kg|quilo|quilos|gramas?|g)\s+(?:de\s+)?([a-z√°√†√£√¢√ß√©√™√≠√≥√¥√µ√∫\s]+)',
        r'(\d+(?:[.,]\d+)?)\s*([a-z√°√†√£√¢√ß√©√™√≠√≥√¥√µ√∫\s]+?)(?:\s+(?:kg|quilo|quilos|gramas?|g))?',
        r'(?:quero|preciso|vou levar|me vende)\s+(\d+(?:[.,]\d+)?)\s*(?:kg|quilo|quilos|gramas?|g)?\s*(?:de\s+)?([a-z√°√†√£√¢√ß√©√™√≠√≥√¥√µ√∫\s]+)',
    ]
    
    for pattern in patterns:
        matches = re.finditer(pattern, text, re.IGNORECASE)
        for match in matches:
            try:
                if len(match.groups()) == 3:  # quantidade, unidade, produto
                    quantidade_str, unidade, produto = match.groups()
                else:  # quantidade, produto
                    quantidade_str, produto = match.groups()
                    unidade = 'kg'  # default
                
                # Limpa quantidade
                quantidade = float(quantidade_str.replace(',', '.'))
                
                # Limpa produto
                produto = produto.strip()
                if len(produto) >= 3:  # produto m√≠nimo 3 chars
                    items.append({
                        'produto': produto,
                        'quantidade': quantidade,
                        'unidade': unidade,
                        'preco_unitario': None,
                        'preco_total': None
                    })
            except (ValueError, AttributeError):
                continue
    
    return items

def _match_product_in_catalog(item_name: str, catalog_items: List[Dict[str, str]]) -> Dict[str, Any]:
    """Encontra produto no cat√°logo com matching inteligente"""
    item_norm = _norm(item_name)
    
    # Busca exata primeiro
    for catalog_item in catalog_items:
        desc = _norm(catalog_item.get('descricao', '') or catalog_item.get('produto', ''))
        if item_norm in desc or desc in item_norm:
            return {
                'found': True,
                'product': catalog_item,
                'confidence': 'alta',
                'match_type': 'exata'
            }
    
    # Busca por palavras-chave
    item_words = set(item_norm.split())
    best_match = None
    best_score = 0
    
    for catalog_item in catalog_items:
        desc = _norm(catalog_item.get('descricao', '') or catalog_item.get('produto', ''))
        desc_words = set(desc.split())
        
        # Calcula score de similaridade
        intersection = item_words.intersection(desc_words)
        score = len(intersection) / max(len(item_words), len(desc_words))
        
        if score > best_score and score > 0.3:  # threshold m√≠nimo
            best_score = score
            best_match = catalog_item
    
    if best_match:
        confidence = 'alta' if best_score > 0.7 else 'm√©dia' if best_score > 0.5 else 'baixa'
        return {
            'found': True,
            'product': best_match,
            'confidence': confidence,
            'match_type': 'similar',
            'score': best_score
        }
    
    return {
        'found': False,
        'suggestions': _get_similar_products(item_name, catalog_items)
    }

def _get_similar_products(item_name: str, catalog_items: List[Dict[str, str]]) -> List[str]:
    """Retorna produtos similares baseado na busca"""
    item_norm = _norm(item_name)
    suggestions = []
    
    # Categorias para sugest√£o
    categorias = {
        'carne': ['picanha', 'alcatra', 'contrafil√©', 'maminha', 'patinho'],
        'frango': ['coxa', 'sobrecoxa', 'peito', 'asa'],
        'porco': ['pernil', 'costela', 'lombo', 'calabresa', 'lingui√ßa'],
        'frios': ['presunto', 'mortadela', 'queijo', 'salame']
    }
    
    for categoria, produtos in categorias.items():
        if any(word in item_norm for word in [categoria] + produtos):
            # Busca produtos desta categoria no cat√°logo
            for catalog_item in catalog_items:
                desc = _norm(catalog_item.get('descricao', ''))
                if any(p in desc for p in produtos):
                    produto_nome = catalog_item.get('descricao', catalog_item.get('produto', ''))
                    if produto_nome not in suggestions:
                        suggestions.append(produto_nome)
                        if len(suggestions) >= 3:
                            break
            break
    
    return suggestions[:3]

def _calculate_order_total(items: List[Dict[str, Any]]) -> Dict[str, Any]:
    """Calcula total do pedido incluindo taxa de entrega"""
    service_utils = get_service_utils()
    
    subtotal = 0
    items_validos = 0
    
    for item in items:
        if item.get('preco_total'):
            subtotal += float(item['preco_total'])
            items_validos += 1
    
    # Taxa de entrega (simulada - seria calculada baseada no CEP real)
    taxa_entrega = 0  # Default gr√°tis at√© 3km
    
    total = subtotal + taxa_entrega
    
    return {
        'subtotal': subtotal,
        'taxa_entrega': taxa_entrega,
        'total': total,
        'items_validos': items_validos,
        'formatado': {
            'subtotal': service_utils.formatar_valor_monetario(subtotal),
            'taxa_entrega': service_utils.formatar_valor_monetario(taxa_entrega) if taxa_entrega > 0 else "Gr√°tis",
            'total': service_utils.formatar_valor_monetario(total)
        }
    }

def _format_order_summary(items: List[Dict[str, Any]], totals: Dict[str, Any]) -> str:
    """Formata resumo do pedido de forma clara"""
    if not items:
        return "üìã Seu carrinho est√° vazio."
    
    linhas = ["üìã **Resumo do seu pedido:**\n"]
    
    # Itens do pedido
    for i, item in enumerate(items, 1):
        if item.get('produto_encontrado'):
            produto = item['produto_encontrado']['product']
            desc = produto.get('descricao', produto.get('produto', 'Produto'))
            preco_unit = produto.get('preco', 'N/A')
            quantidade = item['quantidade']
            unidade = item.get('unidade', 'kg')
            
            if item.get('preco_total'):
                preco_total = f"R$ {item['preco_total']:.2f}"
            else:
                preco_total = "A calcular"
            
            linhas.append(f"{i}. {desc}")
            linhas.append(f"   üìè {quantidade}{unidade} √ó R$ {preco_unit} = {preco_total}")
        else:
            linhas.append(f"{i}. {item['produto']} ({item['quantidade']}{item.get('unidade', 'kg')})")
            linhas.append(f"   ‚ùì Produto n√£o encontrado - precisa validar")
    
    linhas.append("")
    
    # Totais
    if totals['items_validos'] > 0:
        linhas.append(f"üí∞ **Subtotal:** {totals['formatado']['subtotal']}")
        linhas.append(f"üöö **Entrega:** {totals['formatado']['taxa_entrega']}")
        linhas.append(f"üéØ **Total:** {totals['formatado']['total']}")
    else:
        linhas.append("üí∞ **Total:** A calcular ap√≥s validar produtos")
    
    return "\n".join(linhas)

def respond(message: str, context: dict | None = None):
    """
    Roberto - Especialista em pedidos da 3A Frios
    Gest√£o inteligente de carrinho e processo de compra com insights do Bruno
    """
    text = (message or '').lower()
    acao_especial = None
    
    logger.info(f"[Pedidos] Roberto processando: '{message[:50]}...'")
    logger.info(f"[Pedidos] Contexto recebido - keys: {list((context or {}).keys())}")
    
    # Recuperar contexto
    conversation_history = context.get('conversation_history', []) if context else []
    catalog_items = context.get('catalog_items', []) if context else []
    
    # === INSIGHTS DO BRUNO ANALISTA INVIS√çVEL ===
    bruno_insights = context.get('bruno_insights') if context else None
    roberto_sales_approach = ""
    
    if bruno_insights:
        lead_score = bruno_insights.get('lead_score', 0)
        status = bruno_insights.get('qualificacao_status', 'unknown')
        segmento = bruno_insights.get('segmento', 'unknown')
        urgencia = bruno_insights.get('urgencia', 'baixa')
        pessoas = bruno_insights.get('pessoas')
        
        logger.info(f"[Roberto] Bruno insights: score={lead_score}, status={status}, urgencia={urgencia}")
        
        # Abordagem de vendas baseada nos insights
        if status == 'hot':
            roberto_sales_approach = "üî• LEAD QUENTE - Facilite o fechamento, ofere√ßa condi√ß√µes especiais!"
        elif status == 'warm':
            roberto_sales_approach = "üå°Ô∏è LEAD MORNO - Construa valor, calcule tudo detalhadamente!"
        elif status == 'cold':
            roberto_sales_approach = "‚ùÑÔ∏è LEAD FRIO - Seja educativo, mostre processo simples!"
            
        if urgencia == 'alta':
            roberto_sales_approach += " | ‚ö° URGENTE - Priorize rapidez no atendimento!"
            
        if pessoas and pessoas > 15:
            roberto_sales_approach += f" | üë• EVENTO GRANDE ({pessoas} pessoas) - Sugira desconto por volume!"
            
        if segmento == 'pessoa_juridica':
            roberto_sales_approach += " | üè¢ B2B - Ofere√ßa condi√ß√µes empresariais e faturamento!"
    
    logger.info(f"[Pedidos] Roberto com {len(catalog_items)} produtos no cat√°logo")
    
    # === DETEC√á√ÉO DE TIPOS DE A√á√ÉO ===
    is_greeting = any(k in text for k in ['oi', 'ol√°', 'ola', 'bom dia', 'boa tarde', 'boa noite'])
    is_adding_items = any(k in text for k in ['quero', 'vou levar', 'preciso', 'me vende', 'adicionar'])
    is_confirming = any(k in text for k in ['confirmar', 'finalizar', 'fechar pedido', 't√° certo', 'ok'])
    is_asking_info = any(k in text for k in ['total', 'quanto fica', 'valor', 'entrega', 'pagamento'])
    
    # Detecta se tem itens na mensagem
    items_detectados = _extract_items_from_message(message)
    
    # === L√ìGICA PRINCIPAL DO ROBERTO ===
    
    # Sauda√ß√£o inicial
    if is_greeting and not items_detectados and not is_adding_items:
        conv_type = "primeira_interacao" if not conversation_history else "conversa_ativa"
        if conv_type == "primeira_interacao":
            resposta = f"""Oi! Eu sou o Roberto, especialista em pedidos da 3A Frios! üìãü•©

Estou aqui para te ajudar a montar seu pedido com muito cuidado e aten√ß√£o. Posso:

üõí Organizar seus itens no carrinho
üí∞ Calcular valores e total do pedido  
üìç Verificar taxa de entrega por CEP
üí≥ Explicar formas de pagamento

Me conte: o que voc√™ gostaria de pedir hoje?"""
        else:
            resposta = f"Oi! Roberto aqui novamente! üòä Vamos continuar com seu pedido?"
        
        return {
            'resposta': resposta,
            'acao_especial': acao_especial,
        }
    
    # Cliente est√° adicionando itens
    if items_detectados or is_adding_items:
        acao_especial = '[ACAO:CRIAR_OU_ATUALIZAR_PEDIDO]'
        
        if items_detectados:
            logger.info(f"[Pedidos] Roberto identificou {len(items_detectados)} itens")
            
            # Processa itens com cat√°logo
            carrinho = []
            itens_validados = 0
            itens_nao_encontrados = []
            
            for item in items_detectados:
                if catalog_items:
                    resultado = _match_product_in_catalog(item['produto'], catalog_items)
                    item['produto_encontrado'] = resultado
                    
                    if resultado['found']:
                        produto = resultado['product']
                        preco_unit = float(produto.get('preco', '0').replace(',', '.'))
                        preco_total = preco_unit * item['quantidade']
                        
                        item['preco_unitario'] = preco_unit
                        item['preco_total'] = preco_total
                        itens_validados += 1
                    else:
                        itens_nao_encontrados.append(item)
                
                carrinho.append(item)
            
            # Calcula totais
            totals = _calculate_order_total(carrinho)
            
            # Constr√≥i resposta
            if itens_validados > 0:
                resumo = _format_order_summary(carrinho, totals)
                
                if itens_nao_encontrados:
                    resposta = f"""Oi! Roberto da 3A Frios aqui! üòä

{resumo}

‚ö†Ô∏è **Aten√ß√£o:** Alguns itens do seu carrinho precisam ser validados:
"""
                    for item in itens_nao_encontrados:
                        sugestoes = item['produto_encontrado'].get('suggestions', [])
                        if sugestoes:
                            resposta += f"\n‚ùì '{item['produto']}' - Voc√™ quis dizer: {', '.join(sugestoes[:2])}?"
                        else:
                            resposta += f"\n‚ùì '{item['produto']}' - N√£o encontrei este produto"
                    
                    resposta += f"\n\nüí¨ Me confirma os produtos corretos que eu atualizo seu carrinho!"
                else:
                    resposta = f"""Perfeito! Roberto aqui organizou seu carrinho! üéØ

{resumo}

‚úÖ **Pr√≥ximos passos:**
‚Ä¢ Me informe seu CEP para calcular a entrega
‚Ä¢ Escolha a forma de pagamento  
‚Ä¢ Confirme o pedido

üí¨ Quer adicionar mais alguma coisa no carrinho ou posso prosseguir?"""
            
            else:
                # Nenhum item foi validado
                resposta = f"""Oi! Roberto da 3A Frios aqui! üòä

Entendi que voc√™ quer fazer um pedido, mas preciso validar os produtos:

"""
                for item in items_detectados:
                    sugestoes = item.get('produto_encontrado', {}).get('suggestions', [])
                    if sugestoes:
                        resposta += f"‚ùì '{item['produto']}' - Voc√™ quis dizer: {', '.join(sugestoes[:2])}?\n"
                    else:
                        resposta += f"‚ùì '{item['produto']}' - N√£o encontrei este produto\n"
                
                resposta += f"\nüí° **Dica:** Posso te ajudar! Me fale que tipo de carne ou produto voc√™ est√° procurando que eu encontro as op√ß√µes dispon√≠veis!"
        
        else:
            # Cliente quer adicionar mas n√£o especificou itens
            resposta = f"""Oi! Roberto da 3A Frios! üòäüõí

Perfeito, vamos montar seu pedido! Me conte:

üìù **Que produtos voc√™ quer?**
üìè **Qual quantidade de cada um?**

Exemplo: "Quero 1kg de picanha e 500g de lingui√ßa"

Estou aqui para organizar tudo certinho para voc√™! üí™"""
    
    # Cliente perguntando sobre informa√ß√µes do pedido
    elif is_asking_info:
        resposta = f"""Oi! Roberto aqui! üìä

**Informa√ß√µes importantes sobre seu pedido:**

üí≥ **Formas de pagamento:**
‚Ä¢ Dinheiro na entrega
‚Ä¢ Cart√£o na entrega  
‚Ä¢ PIX
‚Ä¢ Transfer√™ncia banc√°ria

üöö **Taxa de entrega:**
‚Ä¢ At√© 3km: Gr√°tis
‚Ä¢ 3km a 5km: R$ 3,00
‚Ä¢ Acima de 5km: R$ 5,00

üí∞ **Total:** Ser√° calculado com base nos itens do seu carrinho + entrega
‚è∞ **Prazo:** 24-48h na regi√£o
üìû **Pedidos:** {DELIVERY_INFO['horario_pedidos']}

üí¨ J√° tem produtos em mente ou quer que eu te ajude a escolher?"""
    
    # Fallback inteligente do Roberto
    else:
        # Usa OpenAI para casos complexos
        if catalog_items:
            catalog_preview = "\n".join([
                f"‚Ä¢ {item.get('descricao', item.get('produto', ''))} - R$ {item.get('preco', 'N/A')}"
                for item in catalog_items[:8]
            ])
            
            prompt = f"""Voc√™ √© o Roberto, especialista em pedidos da 3A Frios.

PERSONALIDADE:
- Nome: Roberto, especialista em pedidos
- Tom: eficiente, atencioso e organizador  
- Sempre se apresente como Roberto da 3A Frios
- Use emojis relacionados a pedidos (üìãüõíüí∞üöö)
- Seja preciso com valores e informa√ß√µes
- Guie o cliente pelo processo passo a passo

CAT√ÅLOGO DISPON√çVEL:
{catalog_preview}

FORMAS DE PAGAMENTO: Dinheiro, Cart√£o, PIX, Transfer√™ncia
ENTREGA: Gr√°tis at√© 3km, R$ 3,00 (3-5km), R$ 5,00 (+5km)
PRAZO: 24-48h na regi√£o

INSTRU√á√ÉO: Ajude o cliente com seu pedido de forma organizada e eficiente."""

            try:
                ai_response = generate_response(prompt, message or '')
                if ai_response and len(ai_response.strip()) > 10:
                    resposta = ai_response.strip()
                    
                    # Garante que Roberto se apresentou
                    if 'Roberto' not in resposta:
                        resposta = f"Oi! Roberto da 3A Frios aqui! üòäüìã {resposta}"
                else:
                    raise Exception("Resposta AI inadequada")
                    
            except Exception as e:
                logger.error(f"[Pedidos] Roberto fallback: {e}")
                resposta = f"Oi! Roberto da 3A Frios! üòäüìã Estou aqui para te ajudar com seu pedido. Me conta o que voc√™ precisa que eu organizo tudo certinho!"
        
        else:
            resposta = f"Oi! Roberto da 3A Frios! üòäüìã Especialista em pedidos aqui! Me conta o que voc√™ quer pedir que eu organizo tudo para voc√™!"
    
    logger.info(f"[Pedidos] Roberto finalizou: {len(resposta)} chars | A√ß√£o: {acao_especial}")
    
    return {
        'resposta': resposta,
        'acao_especial': acao_especial,
    }